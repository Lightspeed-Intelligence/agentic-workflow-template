# Reusable Workflow: Issue Dispatch
# æ ¹æ® Issue æ ‡ç­¾è‡ªåŠ¨åˆ†å‘åˆ°å¯¹åº” Skill
name: Issue Dispatch (Reusable)

on:
  workflow_call:
    inputs:
      use_feishu_notify:
        description: 'æ˜¯å¦å‘é€é£žä¹¦é€šçŸ¥'
        type: boolean
        default: true
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      ANTHROPIC_BASE_URL:
        required: false
      PAT_TOKEN:
        required: false
      FEISHU_WEBHOOK_TOKEN:
        required: false

jobs:
  dispatch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN || github.token }}

      - name: Analyze Issue with Claude
        id: analyze
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          github_token: ${{ github.token }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            ä»“åº“: ${{ github.repository }}
            ä»“åº“ URL: https://github.com/${{ github.repository }}

            æ ¹æ® Issue æ ‡ç­¾å’Œå†…å®¹ï¼Œé€‰æ‹© `bug-analyze`ã€`feature-review` æˆ– `answer-question` skill å¤„ç†ï¼Œå¹¶ä½¿ç”¨ `gh issue comment` å°†åˆ†æžç»“æžœå‘è¡¨åˆ° Issueã€‚

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            Labels: ${{ join(github.event.issue.labels.*.name, ', ') }}
            Body:
            ${{ github.event.issue.body }}

            å®Œæˆåˆ†æžåŽå¿…é¡»è°ƒç”¨ `gh issue comment ${{ github.event.issue.number }} --body "..."` å‘è¡¨è¯„è®ºã€‚
            æ³¨æ„: æ‰€æœ‰ä»£ç é“¾æŽ¥å¿…é¡»ä½¿ç”¨ https://github.com/${{ github.repository }}/blob/main/... æ ¼å¼ã€‚
          claude_args: |
            --model opus --allowedTools "Bash(gh issue:*),Bash(gh pr:*),Bash(git:*),Read,Write,Edit,Glob,Grep,Task,Skill"
            --json-schema '{
              "type": "object",
              "properties": {
                "description": {"type": "string", "description": "æ‰§è¡Œç»“æžœçš„ä¸€å¥è¯æ‘˜è¦ï¼Œç”¨äºŽé€šçŸ¥"},
                "issue_type": {"type": "string", "enum": ["bug", "feature", "question"], "description": "Issue ç±»åž‹"},
                "severity": {"type": "string", "enum": ["critical", "high", "medium", "low", "n/a"], "description": "Bug ä¸¥é‡ç¨‹åº¦"},
                "cost": {"type": "string", "enum": ["small", "medium", "large", "extra-large", "n/a"], "description": "éœ€æ±‚é¢„ä¼°æˆæœ¬"}
              },
              "required": ["description", "issue_type"]
            }'

      - name: Output Result
        if: always()
        run: |
          echo "## Issue Analysis Result" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.analyze.outputs.structured_output }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Parse Analysis Output
        if: always() && inputs.use_feishu_notify
        id: parse
        run: |
          STRUCTURED_OUTPUT='${{ steps.analyze.outputs.structured_output }}'

          if [ -n "$STRUCTURED_OUTPUT" ] && [ "$STRUCTURED_OUTPUT" != "null" ]; then
            DESCRIPTION=$(echo "$STRUCTURED_OUTPUT" | jq -r '.description // "æ— æè¿°"')
            ISSUE_TYPE=$(echo "$STRUCTURED_OUTPUT" | jq -r '.issue_type // "unknown"')
            SEVERITY=$(echo "$STRUCTURED_OUTPUT" | jq -r '.severity // "n/a"')
            COST=$(echo "$STRUCTURED_OUTPUT" | jq -r '.cost // "n/a"')

            TITLE="Issue åˆ†æž: ${ISSUE_TYPE}"
            if [ "$ISSUE_TYPE" == "bug" ]; then
              TITLE="Bug åˆ†æž - ä¸¥é‡ç¨‹åº¦: ${SEVERITY}"
              case "$SEVERITY" in
                "critical") STATUS="error" ;;
                "high") STATUS="warning" ;;
                *) STATUS="info" ;;
              esac
            elif [ "$ISSUE_TYPE" == "feature" ]; then
              TITLE="éœ€æ±‚è¯„å®¡ - æˆæœ¬: ${COST}"
              STATUS="info"
            else
              STATUS="info"
            fi
          else
            TITLE="Issue åˆ†æžå¤±è´¥"
            DESCRIPTION="æœªèƒ½èŽ·å–ç»“æž„åŒ–è¾“å‡º"
            STATUS="warning"
          fi

          if [ "${{ job.status }}" != "success" ]; then
            STATUS="warning"
            DESCRIPTION="GitHub Action æ‰§è¡Œå¤±è´¥"
          fi

          echo "status=${STATUS}" >> $GITHUB_OUTPUT
          echo "title=${TITLE}" >> $GITHUB_OUTPUT

          # å¤šè¡Œè¾“å‡ºä½¿ç”¨ heredoc
          {
            echo 'description<<EOF'
            echo "**${{ github.repository }}** #${{ github.event.issue.number }}"
            echo "*${{ github.event.issue.title }}*"
            echo "${DESCRIPTION}"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Checkout Action
        if: always() && inputs.use_feishu_notify
        uses: actions/checkout@v5
        with:
          repository: vast-enterprise/agentic-workflow-template
          path: .agentic-actions
          sparse-checkout: .github/actions

      - name: Notify Feishu
        if: always() && inputs.use_feishu_notify
        uses: ./.agentic-actions/.github/actions/feishu-notify
        with:
          webhook_token: ${{ secrets.FEISHU_WEBHOOK_TOKEN }}
          title: ${{ steps.parse.outputs.title }}
          description: ${{ steps.parse.outputs.description }}
          link_text: 'ðŸ”— æŸ¥çœ‹ Issue'
          link_url: ${{ github.event.issue.html_url }}
          status: ${{ steps.parse.outputs.status }}

    outputs:
      structured_output: ${{ steps.analyze.outputs.structured_output }}
