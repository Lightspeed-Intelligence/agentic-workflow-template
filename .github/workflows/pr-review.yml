# Reusable Workflow: PR Review
# è‡ªåŠ¨å®¡æŸ¥ PR
name: PR Review (Reusable)

on:
  workflow_call:
    inputs:
      use_feishu_notify:
        description: 'æ˜¯å¦å‘é€é£žä¹¦é€šçŸ¥'
        type: boolean
        default: true
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      ANTHROPIC_BASE_URL:
        required: false
      PAT_TOKEN:
        required: false
      FEISHU_WEBHOOK_TOKEN:
        required: false

jobs:
  review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN || github.token }}

      - name: PR Review with Claude
        id: review
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          github_token: ${{ github.token }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: true
          prompt: |
            æ‰§è¡Œ `pr-review` skill å®¡æŸ¥ PR #${{ github.event.pull_request.number }}ã€‚

            Title: ${{ github.event.pull_request.title }}
            Author: ${{ github.event.pull_request.user.login }}
          claude_args: |
            --model opus --allowedTools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Read,Glob,Grep,Task"
            --json-schema '{
              "type": "object",
              "properties": {
                "description": {"type": "string", "description": "å®¡æŸ¥ç»“è®ºä¸€å¥è¯æ‘˜è¦ï¼Œå¦‚ï¼šä»£ç è‰¯å¥½ï¼Œå‘çŽ°2ä¸ªå°é—®é¢˜"},
                "conclusion": {"type": "string", "enum": ["APPROVE", "REQUEST_CHANGES", "COMMENT"], "description": "å®¡æŸ¥ç»“è®º"},
                "critical_count": {"type": "integer", "description": "é˜»å¡žé—®é¢˜æ•°é‡"},
                "important_count": {"type": "integer", "description": "é‡è¦å»ºè®®æ•°é‡"},
                "suggestion_count": {"type": "integer", "description": "å°é—®é¢˜æ•°é‡"}
              },
              "required": ["description", "conclusion", "critical_count", "important_count", "suggestion_count"]
            }'

      - name: Output Structured Result
        if: always()
        run: |
          echo "## PR Review Result" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.review.outputs.structured_output }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Parse Review Output
        if: always() && inputs.use_feishu_notify
        id: parse
        run: |
          STRUCTURED_OUTPUT='${{ steps.review.outputs.structured_output }}'
          if [ -n "$STRUCTURED_OUTPUT" ] && [ "$STRUCTURED_OUTPUT" != "null" ]; then
            CONCLUSION=$(echo "$STRUCTURED_OUTPUT" | jq -r '.conclusion // "UNKNOWN"')
            DESCRIPTION=$(echo "$STRUCTURED_OUTPUT" | jq -r '.description // "å®¡æŸ¥å®Œæˆ"')
            CRITICAL=$(echo "$STRUCTURED_OUTPUT" | jq -r '.critical_count // 0')
            IMPORTANT=$(echo "$STRUCTURED_OUTPUT" | jq -r '.important_count // 0')
            SUGGESTION=$(echo "$STRUCTURED_OUTPUT" | jq -r '.suggestion_count // 0')
          else
            CONCLUSION="UNKNOWN"
            DESCRIPTION="æœªèƒ½èŽ·å–å®¡æŸ¥ç»“æžœ"
            CRITICAL=0
            IMPORTANT=0
            SUGGESTION=0
          fi

          case "$CONCLUSION" in
            "APPROVE") STATUS="success" ;;
            "REQUEST_CHANGES") STATUS="error" ;;
            *) STATUS="info" ;;
          esac

          if [ "${{ job.status }}" != "success" ]; then
            STATUS="warning"
            DESCRIPTION="GitHub Action æ‰§è¡Œå¤±è´¥"
          fi

          echo "status=${STATUS}" >> $GITHUB_OUTPUT
          echo "title=PR å®¡æŸ¥: ${CONCLUSION}" >> $GITHUB_OUTPUT

          # å¤šè¡Œè¾“å‡ºä½¿ç”¨ heredoc
          {
            echo 'description<<EOF'
            echo "**${{ github.repository }}** PR #${{ github.event.pull_request.number }}"
            echo "*${{ github.event.pull_request.title }}*"
            echo "${DESCRIPTION}"
            echo "ðŸ”´ ${CRITICAL} | ðŸŸ  ${IMPORTANT} | ðŸŸ¢ ${SUGGESTION}"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Checkout Action
        if: always() && inputs.use_feishu_notify && secrets.FEISHU_WEBHOOK_TOKEN != ''
        uses: actions/checkout@v5
        with:
          repository: vast-enterprise/agentic-workflow-template
          path: .agentic-actions
          sparse-checkout: .github/actions

      - name: Notify Feishu
        if: always() && inputs.use_feishu_notify && secrets.FEISHU_WEBHOOK_TOKEN != ''
        uses: ./.agentic-actions/.github/actions/feishu-notify
        with:
          webhook_token: ${{ secrets.FEISHU_WEBHOOK_TOKEN }}
          title: ${{ steps.parse.outputs.title }}
          description: ${{ steps.parse.outputs.description }}
          link_text: 'ðŸ”— æŸ¥çœ‹ PR'
          link_url: ${{ github.event.pull_request.html_url }}
          status: ${{ steps.parse.outputs.status }}

    outputs:
      structured_output: ${{ steps.review.outputs.structured_output }}
