# Reusable Workflow: Issue Implementation
# ç”¨æˆ·ç¡®è®¤åŽè‡ªåŠ¨å®žçŽ°ä»£ç 
name: Issue Implementation (Reusable)

on:
  workflow_call:
    inputs:
      trigger_keywords:
        description: 'è§¦å‘å®žçŽ°çš„å…³é”®è¯ JSON æ•°ç»„'
        type: string
        default: '["/impl", "ok", "OK", "Ok", "oK"]'
      use_feishu_notify:
        description: 'æ˜¯å¦å‘é€é£žä¹¦é€šçŸ¥'
        type: boolean
        default: true
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      ANTHROPIC_BASE_URL:
        required: false
      PAT_TOKEN:
        required: false
      FEISHU_WEBHOOK_TOKEN:
        required: false

jobs:
  implement:
    runs-on: ubuntu-latest
    if: |
      startsWith(github.event.comment.body, '/impl') ||
      contains(fromJSON(inputs.trigger_keywords), github.event.comment.body)
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN || github.token }}

      - name: Implement with Claude
        id: implement
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          github_token: ${{ github.token }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            ä»“åº“: ${{ github.repository }}
            ä»“åº“ URL: https://github.com/${{ github.repository }}

            ç”¨æˆ·å·²ç¡®è®¤ï¼Œæ‰§è¡Œ `implement` skill å®žçŽ° Issue #${{ github.event.issue.number }}ï¼Œå¹¶ä½¿ç”¨ `gh issue comment` æŠ¥å‘Šè¿›åº¦ã€‚

            Issue: ${{ github.event.issue.title }}
            Body:
            ${{ github.event.issue.body }}

            è§¦å‘è¯„è®º: ${{ github.event.comment.body }}

            å®žçŽ°å®ŒæˆåŽå¿…é¡»è°ƒç”¨ `gh issue comment ${{ github.event.issue.number }} --body "..."` å‘è¡¨è¯„è®ºï¼Œè¯´æ˜Žåˆ›å»ºçš„ PR æˆ–é‡åˆ°çš„é—®é¢˜ã€‚
            æ³¨æ„: æ‰€æœ‰ä»£ç é“¾æŽ¥å¿…é¡»ä½¿ç”¨ https://github.com/${{ github.repository }}/blob/main/... æ ¼å¼ã€‚
          claude_args: |
            --model opus --allowedTools "Bash(gh issue:*),Bash(gh pr:*),Bash(git:*),Read,Write,Edit,Glob,Grep,Task,Skill"
            --json-schema '{
              "type": "object",
              "properties": {
                "description": {"type": "string", "description": "å®žçŽ°ç»“æžœä¸€å¥è¯æ‘˜è¦ï¼Œå¦‚ï¼šå·²åˆ›å»º PR #123"},
                "status": {"type": "string", "enum": ["success", "failed", "blocked"], "description": "å®žçŽ°çŠ¶æ€"},
                "branch_name": {"type": "string", "description": "åˆ›å»ºçš„åˆ†æ”¯å"},
                "pr_number": {"type": "integer", "description": "PR ç¼–å·"},
                "pr_url": {"type": "string", "description": "PR é“¾æŽ¥"}
              },
              "required": ["description", "status"]
            }'

      - name: Output Result
        if: always()
        run: |
          echo "## Issue Implementation Result" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.implement.outputs.structured_output }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Parse implement output
        if: always() && inputs.use_feishu_notify
        id: parse
        run: |
          STRUCTURED_OUTPUT='${{ steps.implement.outputs.structured_output }}'
          if [ -n "$STRUCTURED_OUTPUT" ] && [ "$STRUCTURED_OUTPUT" != "null" ]; then
            STATUS_VAL=$(echo "$STRUCTURED_OUTPUT" | jq -r '.status // "unknown"')
            DESCRIPTION=$(echo "$STRUCTURED_OUTPUT" | jq -r '.description // "å®žçŽ°ä»»åŠ¡å®Œæˆ"')
          else
            STATUS_VAL="failed"
            DESCRIPTION="æœªèƒ½èŽ·å–å®žçŽ°ç»“æžœ"
          fi

          case "$STATUS_VAL" in
            "success") STATUS="success" ;;
            "blocked") STATUS="warning" ;;
            *) STATUS="error" ;;
          esac

          if [ "${{ job.status }}" != "success" ]; then
            STATUS="warning"
            DESCRIPTION="GitHub Action æ‰§è¡Œå¤±è´¥"
          fi

          echo "status=${STATUS}" >> $GITHUB_OUTPUT
          echo "title=å®žçŽ°: ${STATUS_VAL}" >> $GITHUB_OUTPUT

          # å¤šè¡Œè¾“å‡ºä½¿ç”¨ heredoc
          {
            echo 'description<<EOF'
            echo "**${{ github.repository }}** #${{ github.event.issue.number }}"
            echo "*${{ github.event.issue.title }}*"
            echo "${DESCRIPTION}"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Checkout Action
        if: always() && inputs.use_feishu_notify
        uses: actions/checkout@v5
        with:
          repository: vast-enterprise/agentic-workflow-template
          path: .agentic-actions
          sparse-checkout: .github/actions

      - name: Notify Feishu
        if: always() && inputs.use_feishu_notify
        uses: ./.agentic-actions/.github/actions/feishu-notify
        with:
          webhook_token: ${{ secrets.FEISHU_WEBHOOK_TOKEN }}
          title: ${{ steps.parse.outputs.title }}
          description: ${{ steps.parse.outputs.description }}
          link_text: 'ðŸ”— æŸ¥çœ‹ Issue'
          link_url: ${{ github.event.issue.html_url }}
          status: ${{ steps.parse.outputs.status }}

    outputs:
      structured_output: ${{ steps.implement.outputs.structured_output }}
