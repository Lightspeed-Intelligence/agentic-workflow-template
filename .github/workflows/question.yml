# Reusable Workflow: Answer Question
# å›žç­” Issue ä¸­çš„é—®é¢˜
name: Answer Question (Reusable)

on:
  workflow_call:
    inputs:
      trigger_keywords:
        description: 'è§¦å‘é—®ç­”çš„å…³é”®è¯ JSON æ•°ç»„'
        type: string
        default: '["/ask", "/question", "/q", "/?"]'
      use_feishu_notify:
        description: 'æ˜¯å¦å‘é€é£žä¹¦é€šçŸ¥'
        type: boolean
        default: true
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      ANTHROPIC_BASE_URL:
        required: false
      PAT_TOKEN:
        required: false
      FEISHU_WEBHOOK_TOKEN:
        required: false

jobs:
  answer:
    runs-on: ubuntu-latest
    if: |
      startsWith(github.event.comment.body, '/ask') ||
      startsWith(github.event.comment.body, '/question') ||
      startsWith(github.event.comment.body, '/q') ||
      startsWith(github.event.comment.body, '/?')
    permissions:
      contents: read
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN || github.token }}

      - name: Answer Question with Claude
        id: answer
        uses: anthropics/claude-code-action@v1
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
        with:
          github_token: ${{ github.token }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            ä»“åº“: ${{ github.repository }}
            ä»“åº“ URL: https://github.com/${{ github.repository }}

            æ‰§è¡Œ `answer-question` skill å›žç­”é—®é¢˜ï¼Œå¹¶ä½¿ç”¨ `gh issue comment` å°†å›žç­”å‘è¡¨åˆ° Issueã€‚

            Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}
            Body:
            ${{ github.event.issue.body }}

            é—®é¢˜: ${{ github.event.comment.body }}

            å®ŒæˆåŽå¿…é¡»è°ƒç”¨ `gh issue comment ${{ github.event.issue.number }} --body "..."` å‘è¡¨è¯„è®ºã€‚
            æ³¨æ„: æ‰€æœ‰ä»£ç é“¾æŽ¥å¿…é¡»ä½¿ç”¨ https://github.com/${{ github.repository }}/blob/main/... æ ¼å¼ã€‚
          claude_args: |
            --model opus --allowedTools "Bash(gh issue comment:*),Read,Glob,Grep,Skill"
            --json-schema '{
              "type": "object",
              "properties": {
                "description": {"type": "string", "description": "å›žç­”å†…å®¹çš„ä¸€å¥è¯æ‘˜è¦"}
              },
              "required": ["description"]
            }'

      - name: Output Result
        if: always()
        run: |
          echo "## Answer Result" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.answer.outputs.structured_output }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Parse answer output
        if: always() && inputs.use_feishu_notify
        id: parse
        run: |
          STRUCTURED_OUTPUT='${{ steps.answer.outputs.structured_output }}'
          if [ -n "$STRUCTURED_OUTPUT" ] && [ "$STRUCTURED_OUTPUT" != "null" ]; then
            DESCRIPTION=$(echo "$STRUCTURED_OUTPUT" | jq -r '.description // "å·²å›žç­”é—®é¢˜"')
            STATUS="success"
          else
            DESCRIPTION="æœªèƒ½èŽ·å–å›žç­”ç»“æžœ"
            STATUS="error"
          fi

          if [ "${{ job.status }}" != "success" ]; then
            STATUS="warning"
            DESCRIPTION="GitHub Action æ‰§è¡Œå¤±è´¥"
          fi

          echo "status=${STATUS}" >> $GITHUB_OUTPUT
          echo "title=é—®é¢˜å·²å›žç­”" >> $GITHUB_OUTPUT

          # å¤šè¡Œè¾“å‡ºä½¿ç”¨ heredoc
          {
            echo 'description<<EOF'
            echo "**${{ github.repository }}** #${{ github.event.issue.number }}"
            echo "*${{ github.event.issue.title }}*"
            echo "${DESCRIPTION}"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Checkout Action
        if: always() && inputs.use_feishu_notify
        uses: actions/checkout@v5
        with:
          repository: vast-enterprise/agentic-workflow-template
          path: .agentic-actions
          sparse-checkout: .github/actions
          sparse-checkout-cone-mode: false

      - name: Notify Feishu
        if: always() && inputs.use_feishu_notify
        uses: ./.agentic-actions/.github/actions/feishu-notify
        with:
          webhook_token: ${{ secrets.FEISHU_WEBHOOK_TOKEN }}
          title: ${{ steps.parse.outputs.title }}
          description: ${{ steps.parse.outputs.description }}
          link_text: 'ðŸ”— æŸ¥çœ‹ Issue'
          link_url: ${{ github.event.issue.html_url }}
          status: ${{ steps.parse.outputs.status }}

    outputs:
      structured_output: ${{ steps.answer.outputs.structured_output }}
